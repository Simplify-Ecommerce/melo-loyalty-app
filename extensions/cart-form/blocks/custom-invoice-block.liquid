
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">

{% if cart.item_count > 0 %}
<div class="custom-invoice-block" {{ block.shopify_attributes }}>
  <div class="custom-invoice-card">
    <h3 class="custom-invoice-title">{{ block.settings.title }}</h3>
    <p class="custom-invoice-subtitle">{{ block.settings.subtitle }}</p>

    <div class="custom-invoice-toggle-wrapper">
      <h4 class="custom-invoice-toggle-title">¿Quieres factura personalizada?</h4>
      <label class="custom-invoice-toggle-label" for="custom-invoice-toggle">
        <button
          type="button"
          role="switch"
          id="custom-invoice-toggle"
          class="radix-switch"
          aria-checked="false"
          aria-label="Factura personalizada"
        >
          <span class="radix-switch-thumb"></span>
        </button>
        <span class="custom-invoice-toggle-text" id="toggle-text"> No, no quiero una factura personalizada </span>
      </label>
      <span class="custom-invoice-error" id="checkout-blocked-error"></span>
    </div>

    {% if customer %}
    <div id="customer-data-summary" class="customer-data-summary" style="display: none;">
      <div id="customer-data-summary-content"></div>
      <button type="button" id="update-data-summary-btn" class="custom-invoice-link-btn">
        Actualizar datos
      </button>
    </div>
    {% endif %}
  </div>

  <dialog id="custom-invoice-modal" class="custom-invoice-modal" aria-labelledby="modal-title">
    <div class="custom-invoice-modal-content">
      <button class="custom-invoice-modal-close" id="modal-close" aria-label="Cerrar modal">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>

      <h2 id="modal-title" class="custom-invoice-modal-title">Completa tus datos</h2>
      <p class="custom-invoice-modal-subtitle">Regístrate o inicia sesión para completar los datos de tu factura personalizada.</p>

      <div id="modal-content">
        {% if customer %}
          <div id="logged-in-content">
            <div id="customer-data-display" style="display: none;">
              <div class="customer-data-summary">
                <h3>Sus datos están completos</h3>
                <div id="customer-data-details"></div>
                <button type="button" id="update-data-btn" class="custom-invoice-btn custom-invoice-btn-secondary">
                  Actualizar datos
                </button>
              </div>
            </div>
            <div id="customer-form-container" style="display: none;">
              {% render 'custom-invoice-form', is_update: true, customer: customer, segmentation_section_title: block.settings.segmentation_section_title, segmentation_label: block.settings.segmentation_label, segmentation_options: block.settings.segmentation_options %}
            </div>
            <div id="form-skeleton-loader" style="display: none;">
              <div style="display: flex; justify-content: center; align-items: center; min-height: 300px; padding: 2rem;">
                <span class="loader"></span>
              </div>
            </div>
            <div id="loading-indicator" style="display: none;">
              <p>Cargando datos...</p>
            </div>
          </div>
        {% else %}
          <div id="not-logged-in-content">
            <p class="custom-invoice-login-prompt">
              ¿Ya tienes cuenta?
              <a href="{{ routes.storefront_login_url }}" id="login-link"
                >Inicia sesión aquí</a
              >
            </p>
            <div class="custom-invoice-separator">
              <span>O regístrate con tus datos</span>
            </div>
            <div id="register-form-container">
              {% render 'custom-invoice-form', is_update: false, segmentation_section_title: block.settings.segmentation_section_title, segmentation_label: block.settings.segmentation_label, segmentation_options: block.settings.segmentation_options %}
            </div>
          </div>
        {% endif %}
      </div>
    </div>
    <div class="action-container">
      <div id="form-message" class="custom-invoice-message" style="display: none;"></div>
      <div class="action-buttons">
        <button id="action-cancel-btn" type="button">Cancelar</button>
        <button id="action-update-btn" type="button">
          {% if customer %}Actualizar{% else %}Registrarse{% endif %}
        </button>
      </div>
    </div>
  </dialog>
</div>

<script>
window.config = {
  CART_URL: '{{ routes.cart_url }}',
  LOGIN_URL: '{{ routes.storefront_login_url }}',
  CUSTOMER_ID: '{% if customer %}{{ customer.id }}{% endif %}',
  IS_LOGGED_IN: {% if customer %}true{% else %}false{% endif %},
  DGI_COUNTRY_CODES_URL: '{{ "dgi-country-codes.json" | asset_url }}',
  SUPPORT_LINK: '{% if block.settings.support_link %}{{ block.settings.support_link }}{% else %}#{% endif %}'
};
</script>
<script src="{{ "custom-invoice-block.js" | asset_url }}" defer></script>

{% endif %}

{% schema %}
{
  "name": "Factura Personalizada",
  "target": "section",
  "enabled_on": {
    "templates": ["cart"]
  },
  "stylesheet": "cart-form.css",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Título",
      "default": "¿Necesitas factura personalizada?"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Subtítulo",
      "default": "Completa tus datos para generar una factura personalizada"
    },
    {
      "type": "url",
      "id": "support_link",
      "label": "Link de contacto con soporte",
      "info": "URL a mostrar cuando el usuario intenta modificar datos que no se pueden cambiar"
    },
    {
      "type": "header",
      "content": "Sección de Segmentación"
    },
    {
      "type": "text",
      "id": "segmentation_section_title",
      "label": "Título de la sección",
      "default": "Información sobre tus mascotas",
      "info": "Título que se mostrará arriba de los checkboxes"
    },
    {
      "type": "text",
      "id": "segmentation_label",
      "label": "Label de los checkboxes",
      "default": "Selecciona tus mascotas",
      "info": "Texto que aparece antes de los checkboxes"
    },
    {
      "type": "text",
      "id": "segmentation_options",
      "label": "Opciones disponibles",
      "default": "Perro,Gato,Aves,Peces,Tortugas,Hámster,Cobayo,Conejo,Hurón,Erizo",
      "info": "Lista de opciones separadas por comas (ej: Perro,Gato,Aves)"
    }
  ]
}
{% endschema %}
