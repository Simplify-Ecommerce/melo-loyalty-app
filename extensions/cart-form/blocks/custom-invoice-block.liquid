{% doc %}
  App block para factura personalizada en el carrito.
  Incluye toggle switch y modal para registro/actualización de datos del cliente.
{% enddoc %}

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">

{% if cart.item_count > 0 %}
<div class="custom-invoice-block" {{ block.shopify_attributes }}>
  <div class="custom-invoice-card">
    <h3 class="custom-invoice-title">{{ block.settings.title }}</h3>
    <p class="custom-invoice-subtitle">{{ block.settings.subtitle }}</p>

    <div class="custom-invoice-toggle-wrapper">
      <label class="custom-invoice-toggle-label" for="custom-invoice-toggle">
        <button
          type="button"
          role="switch"
          id="custom-invoice-toggle"
          class="radix-switch"
          aria-checked="false"
          aria-label="Factura personalizada"
        >
          <span class="radix-switch-thumb"></span>
        </button>
        <span class="custom-invoice-toggle-text" id="toggle-text"> No, no quiero una factura personalizada </span>
      </label>
    </div>

    {% if customer %}
    <div id="customer-data-summary" class="customer-data-summary" style="display: none;">
      <div id="customer-data-summary-content"></div>
      <button type="button" id="update-data-summary-btn" class="custom-invoice-link-btn">
        Actualizar datos
      </button>
    </div>
    {% endif %}
  </div>

  <dialog id="custom-invoice-modal" class="custom-invoice-modal" aria-labelledby="modal-title">
    <div class="custom-invoice-modal-content">
      <button class="custom-invoice-modal-close" id="modal-close" aria-label="Cerrar modal">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>

      <h2 id="modal-title" class="custom-invoice-modal-title">Factura Personalizada</h2>
      <p class="custom-invoice-modal-subtitle">Regístrate o inicia sesión para generar tu factura personalizada.</p>

      <div id="modal-content">
        {% if customer %}
          <div id="logged-in-content">
            <div id="customer-data-display" style="display: none;">
              <div class="customer-data-summary">
                <h3>Sus datos están completos</h3>
                <div id="customer-data-details"></div>
                <button type="button" id="update-data-btn" class="custom-invoice-btn custom-invoice-btn-secondary">
                  Actualizar datos
                </button>
              </div>
            </div>
            <div id="customer-form-container" style="display: none;">
              {% render 'custom-invoice-form', is_update: true, customer: customer %}
            </div>
            <div id="form-skeleton-loader" style="display: none;">
              <div style="display: flex; justify-content: center; align-items: center; min-height: 300px; padding: 2rem;">
                <span class="loader"></span>
              </div>
            </div>
            <div id="loading-indicator" style="display: none;">
              <p>Cargando datos...</p>
            </div>
          </div>
        {% else %}
          <div id="not-logged-in-content">
            <p class="custom-invoice-login-prompt">
              ¿Ya tienes cuenta?
              <a href="{{ routes.storefront_login_url }}" id="login-link"
                >Inicia sesión aquí</a
              >
            </p>
            <div class="custom-invoice-separator">
              <span>O regístrate con tus datos</span>
            </div>
            <div id="register-form-container">
              {% render 'custom-invoice-form', is_update: false %}
            </div>
          </div>
        {% endif %}
      </div>
    </div>
    <div class="action-container">
      <div id="form-message" class="custom-invoice-message" style="display: none;"></div>
      <div class="action-buttons">
        <button id="action-cancel-btn" type="button">Cancelar</button>
        <button id="action-update-btn" type="button">
          {% if customer %}Actualizar{% else %}Registrarse{% endif %}
        </button>
      </div>
    </div>
  </dialog>
</div>

<script>
(function() {
  'use strict';
  
  const toggle = document.getElementById('custom-invoice-toggle');
  const toggleText = document.getElementById('toggle-text');
  const modal = document.getElementById('custom-invoice-modal');
  const modalClose = document.getElementById('modal-close');
  const STORAGE_KEY = 'customInvoicePreference';
  // El app proxy mapea /apps/custom-invoice/* a /api/proxy/*
  // En React Router, las rutas están en api/proxy/customers.$.jsx
  // Usar la ruta del app proxy que Shopify mapea automáticamente
  // Si no funciona, probar con /api/proxy/customers directamente
  const API_BASE = '/apps/custom-invoice/customers';
  const CART_URL = '{{ routes.cart_url }}';
  const LOGIN_URL = '{{ routes.storefront_login_url }}';
  {% if customer %}
  const CUSTOMER_ID = '{{ customer.id }}';
  const IS_LOGGED_IN = true;
  {% else %}
  const IS_LOGGED_IN = false;
  {% endif %}

  // Lista de países en orden alfabético
  const COUNTRIES = [
    'Afganistán', 'Albania', 'Alemania', 'Andorra', 'Angola', 'Antigua y Barbuda', 'Arabia Saudí', 'Argelia', 'Argentina', 'Armenia',
    'Australia', 'Austria', 'Azerbaiyán', 'Bahamas', 'Bangladés', 'Barbados', 'Baréin', 'Bélgica', 'Belice', 'Benín',
    'Bielorrusia', 'Birmania', 'Bolivia', 'Bosnia y Herzegovina', 'Botsuana', 'Brasil', 'Brunéi', 'Bulgaria', 'Burkina Faso', 'Burundi',
    'Bután', 'Cabo Verde', 'Camboya', 'Camerún', 'Canadá', 'Catar', 'Chad', 'Chile', 'China', 'Chipre',
    'Ciudad del Vaticano', 'Colombia', 'Comoras', 'Corea del Norte', 'Corea del Sur', 'Costa de Marfil', 'Costa Rica', 'Croacia', 'Cuba', 'Dinamarca',
    'Dominica', 'Ecuador', 'Egipto', 'El Salvador', 'Emiratos Árabes Unidos', 'Eritrea', 'Eslovaquia', 'Eslovenia', 'España', 'Estados Unidos',
    'Estonia', 'Esuatini', 'Etiopía', 'Filipinas', 'Finlandia', 'Fiyi', 'Francia', 'Gabón', 'Gambia', 'Georgia',
    'Ghana', 'Granada', 'Grecia', 'Guatemala', 'Guinea', 'Guinea-Bisáu', 'Guinea Ecuatorial', 'Guyana', 'Haití', 'Honduras',
    'Hungría', 'India', 'Indonesia', 'Irak', 'Irán', 'Irlanda', 'Islandia', 'Islas Marshall', 'Islas Salomón', 'Israel',
    'Italia', 'Jamaica', 'Japón', 'Jordania', 'Kazajistán', 'Kenia', 'Kirguistán', 'Kiribati', 'Kuwait', 'Laos',
    'Lesoto', 'Letonia', 'Líbano', 'Liberia', 'Libia', 'Liechtenstein', 'Lituania', 'Luxemburgo', 'Macedonia del Norte', 'Madagascar',
    'Malasia', 'Malaui', 'Maldivas', 'Malí', 'Malta', 'Marruecos', 'Mauricio', 'Mauritania', 'México', 'Micronesia',
    'Moldavia', 'Mónaco', 'Mongolia', 'Montenegro', 'Mozambique', 'Namibia', 'Nauru', 'Nepal', 'Nicaragua', 'Níger',
    'Nigeria', 'Noruega', 'Nueva Zelanda', 'Omán', 'Países Bajos', 'Pakistán', 'Palau', 'Palestina', 'Panamá', 'Papúa Nueva Guinea',
    'Paraguay', 'Perú', 'Polonia', 'Portugal', 'Reino Unido', 'República Centroafricana', 'República Checa', 'República del Congo', 'República Democrática del Congo', 'República Dominicana',
    'Ruanda', 'Rumanía', 'Rusia', 'Samoa', 'San Cristóbal y Nieves', 'San Marino', 'San Vicente y las Granadinas', 'Santa Lucía', 'Santo Tomé y Príncipe', 'Senegal',
    'Serbia', 'Seychelles', 'Sierra Leona', 'Singapur', 'Siria', 'Somalia', 'Sri Lanka', 'Sudáfrica', 'Sudán', 'Sudán del Sur',
    'Suecia', 'Suiza', 'Surinam', 'Tailandia', 'Tanzania', 'Tayikistán', 'Timor Oriental', 'Togo', 'Tonga', 'Trinidad y Tobago',
    'Túnez', 'Turkmenistán', 'Turquía', 'Tuvalu', 'Ucrania', 'Uganda', 'Uruguay', 'Uzbekistán', 'Vanuatu', 'Venezuela',
    'Vietnam', 'Yemen', 'Yibuti', 'Zambia', 'Zimbabue'
  ];

  function init() {
    // Asegurarse de que el modal esté cerrado al inicializar
    if (modal) {
      modal.close();
    }
    
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      const d = JSON.parse(saved);
      if (d.wantsInvoice) {
        toggle.setAttribute('aria-checked', 'true');
        updateToggleText();
        
        // Si el toggle está activado (según localStorage), verificar datos del cliente
        if (IS_LOGGED_IN) {
          // Verificar datos del cliente después de un pequeño delay para asegurar que todo esté cargado
          setTimeout(() => {
            loadCustomerDataOnInit();
          }, 500);
        } else {
          // Si no está logueado, NO abrir el modal automáticamente, solo bloquear checkout
          setTimeout(() => {
            disableCheckout();
            console.log('[Checkout] Bloqueado: Usuario no logueado y toggle activo');
          }, 500);
        }
      }
    }
    
    toggle.addEventListener('click', handleToggleChange);
    if (modalClose) {
      modalClose.addEventListener('click', closeModal);
    }
    if (modal) {
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          closeModal();
        }
      });
    }
    
    // Agregar listener al botón de actualizar datos en el resumen
    const updateDataSummaryBtn = document.getElementById('update-data-summary-btn');
    if (updateDataSummaryBtn) {
      updateDataSummaryBtn.addEventListener('click', function() {
        // Primero ocultar cualquier formulario visible antes de abrir el modal
        const fd = document.getElementById('customer-form-container');
        const dd = document.getElementById('customer-data-display');
        if (fd) {
          fd.style.display = 'none';
          fd.style.opacity = '0';
        }
        if (dd) {
          dd.style.display = 'none';
          dd.style.opacity = '0';
        }
        
        openModal();
        // Cargar datos inmediatamente sin delay para mostrar el spinner
        setTimeout(() => {
          loadCustomerData();
        }, 50);
      });
    }
    
    // También manejar el botón "Actualizar datos" dentro del modal (si existe)
    const updateDataBtn = document.getElementById('update-data-btn');
    if (updateDataBtn) {
      updateDataBtn.addEventListener('click', function() {
        // Ocultar el resumen de datos y mostrar el formulario
        const dd = document.getElementById('customer-data-display');
        const fd = document.getElementById('customer-form-container');
        if (dd) {
          dd.style.display = 'none';
          dd.style.opacity = '0';
        }
        // Cargar datos para mostrar el formulario
        loadCustomerData();
      });
    }
    
    interceptCheckoutSubmit();
    checkCheckoutButton();
    window.addEventListener('storage', handleStorageChange);
  }

  function loadCustomerDataOnInit() {
    if (!IS_LOGGED_IN) return;
    
    // Verificar localStorage para saber si el toggle está activo
    const saved = localStorage.getItem(STORAGE_KEY);
    const wantsInvoice = saved ? JSON.parse(saved).wantsInvoice : false;
    
    // Solo proceder si el toggle está activo según localStorage
    if (!wantsInvoice) {
      console.log('[Checkout] Toggle no activo según localStorage, no verificando datos');
      return;
    }
    
    fetch(`${API_BASE}/get?customer_id=${CUSTOMER_ID}`)
      .then(r => r.json())
      .then(d => {
        console.log('[Checkout] Datos del cliente cargados:', d);
        if (d.complete && d.customer) {
          // Datos completos: mostrar resumen y habilitar checkout
          showCustomerDataSummary(d.customer);
          enableCheckout();
          console.log('[Checkout] Habilitado: Usuario logueado con datos completos');
        } else {
          // Datos incompletos: bloquear checkout pero NO abrir modal automáticamente
          disableCheckout();
          console.log('[Checkout] Bloqueado: Usuario logueado pero datos incompletos. Campos faltantes:', d.missingFields || 'desconocidos');
          // NO abrir el modal automáticamente, el usuario lo abrirá cuando intente hacer checkout
        }
      })
      .catch(e => {
        console.error('[Checkout] Error al cargar datos:', e);
        disableCheckout();
        console.log('[Checkout] Bloqueado: Error al verificar datos del cliente');
        // NO abrir el modal automáticamente en caso de error
      });
  }

  function showCustomerDataSummary(c) {
    const summaryContainer = document.getElementById('customer-data-summary');
    const summaryContent = document.getElementById('customer-data-summary-content');
    
    if (!summaryContainer || !summaryContent) return;
    
    if (c && c.metafields) {
      const mf = c.metafields || {};
      const customerTypeLabel = mf.ex_customer_type === '01' ? 'Contribuyente' : 
                                mf.ex_customer_type === '02' ? 'Consumidor final' : 
                                mf.ex_customer_type === '04' ? 'Extranjero' : '';
      
      summaryContent.innerHTML = `
        <div class="customer-data-summary-item">
          <strong>${c.firstName || ''} ${c.lastName || ''}</strong>
        </div>
        <div class="customer-data-summary-item">
          ${mf.ex_tax_id || ''} ${customerTypeLabel ? `(${customerTypeLabel})` : ''}
        </div>
        <div class="customer-data-summary-item">
          ${c.email || ''}
        </div>
      `;
      summaryContainer.style.display = 'block';
    }
  }

  function handleToggleChange(e) {
    e.preventDefault();
    const currentState = toggle.getAttribute('aria-checked') === 'true';
    const newState = !currentState;
    toggle.setAttribute('aria-checked', String(newState));
    updateToggleText();
    const wantsInvoice = newState;
    savePreference({ wantsInvoice });
    
    const summaryContainer = document.getElementById('customer-data-summary');
    
    if (wantsInvoice) {
      // Si el toggle se activa, verificar datos pero NO abrir modal automáticamente
      if (IS_LOGGED_IN) {
        loadCustomerDataOnInit();
      } else {
        // Si no está logueado, abrir modal para registro
      openModal();
        disableCheckout();
        console.log('[Checkout] Bloqueado: Usuario no logueado y toggle activado');
      }
    } else {
      // Si el toggle se desactiva, ocultar resumen y habilitar checkout
      closeModal();
      if (summaryContainer) {
        summaryContainer.style.display = 'none';
      }
      enableCheckout();
      console.log('[Checkout] Habilitado: Toggle desactivado');
    }
    
    checkCheckoutButton();
  }

  function updateToggleText() {
    const isChecked = toggle.getAttribute('aria-checked') === 'true';
    toggleText.textContent = isChecked 
      ? 'Sí, quiero una factura personalizada' 
      : 'No, no quiero una factura personalizada';
  }

  function openModal(showErrors = false) {
    if (modal) {
      // Primero ocultar cualquier contenido visible antes de abrir el modal
      const fd = document.getElementById('customer-form-container');
      const dd = document.getElementById('customer-data-display');
      const skeleton = document.getElementById('form-skeleton-loader');
      const actionUpdateBtn = document.getElementById('action-update-btn');
      
      if (fd) {
        fd.style.display = 'none';
        fd.style.opacity = '0';
      }
      if (dd) {
        dd.style.display = 'none';
        dd.style.opacity = '0';
      }
      if (skeleton) {
        skeleton.style.display = 'none';
        skeleton.style.opacity = '0';
      }
      
      // Establecer el texto correcto del botón según si el usuario está logueado
      if (actionUpdateBtn) {
        actionUpdateBtn.textContent = IS_LOGGED_IN ? 'Actualizar' : 'Registrarse';
        actionUpdateBtn.disabled = false;
      }
      
      modal.showModal();
      
      // Establecer altura inicial del modal para que la animación funcione
      // Usar una altura mínima inicial
      modal.style.height = '200px';
      
      const form = document.getElementById('custom-invoice-form');
      
      if (!showErrors) {
        // Remover la clase "submitted" para que no se muestren errores inicialmente
        if (form) {
          form.classList.remove('submitted');
          // Limpiar todos los errores visuales
          const errorFields = form.querySelectorAll('.custom-invoice-input.error');
          errorFields.forEach(field => {
            field.classList.remove('error');
            const fieldId = field.id;
            if (fieldId) {
              const errorElement = document.getElementById(`${fieldId}_error`);
              if (errorElement) {
                errorElement.classList.remove('show');
                errorElement.textContent = '';
              }
            }
          });
        }
      }
      
      // Inicializar el formulario cuando se abre el modal
      setTimeout(() => {
        initForm();
        // Animar altura cuando se abre el modal
        setTimeout(() => {
          animateModalHeight();
        }, 50);
        // Cargar datos del cliente después de inicializar el formulario
        // para asegurar que las opciones del select estén cargadas
        setTimeout(() => {
          loadCustomerData();
        }, 50);
      }, 100);
    }
  }

  function closeModal() {
    if (modal) {
      modal.close();
      // Limpiar la altura cuando se cierra el modal para que se resetee
      modal.style.height = '';
    }
  }

  function savePreference(d) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(d));
  }

  function getPreference() {
    const s = localStorage.getItem(STORAGE_KEY);
    return s ? JSON.parse(s) : { wantsInvoice: false };
  }

  function checkCustomerDataCompleteness(openModalIfIncomplete = false) {
    if (IS_LOGGED_IN) {
      fetch(`${API_BASE}/get?customer_id=${CUSTOMER_ID}`)
        .then(r => r.json())
        .then(d => {
          console.log('[Checkout] Verificación de datos completos:', d);
          if (d.complete && d.customer) {
            enableCheckout();
            showCustomerDataSummary(d.customer);
            console.log('[Checkout] Habilitado: Datos completos');
          } else {
            disableCheckout();
            console.log('[Checkout] Bloqueado: Datos incompletos. Campos faltantes:', d.missingFields || 'desconocidos');
            // Si se solicita y faltan datos, abrir el modal
            if (openModalIfIncomplete) {
              openModal(true);
              setTimeout(() => {
                loadCustomerData();
              }, 100);
            }
          }
        })
        .catch(e => {
          console.error('[Checkout] Error al verificar datos:', e);
          disableCheckout();
          console.log('[Checkout] Bloqueado: Error al verificar datos');
          // Si hay error y se solicita, abrir el modal
          if (openModalIfIncomplete) {
            openModal(true);
            setTimeout(() => {
              loadCustomerData();
            }, 100);
          }
        });
    } else {
      disableCheckout();
      console.log('[Checkout] Bloqueado: Usuario no logueado');
      // Si no está logueado y se solicita, abrir el modal
      if (openModalIfIncomplete) {
        openModal(true);
      }
    }
  }

  function interceptCheckoutSubmit() {
    // Buscar el formulario del carrito
    const cartForm = document.getElementById('cart') || document.querySelector('form[id*="cart"], form[action*="checkout"], form[action*="/checkout"]');
    if (!cartForm) {
      setTimeout(interceptCheckoutSubmit, 500);
      return;
    }
    
    // Variable para almacenar el estado de los datos del cliente
    let customerDataComplete = null;
    
    // Verificar datos del cliente al cargar la página si está logueado
    if (IS_LOGGED_IN) {
      fetch(`${API_BASE}/get?customer_id=${CUSTOMER_ID}`)
        .then(r => r.json())
        .then(d => {
          customerDataComplete = d.complete && d.customer;
          console.log('[Checkout] Estado de datos al cargar:', customerDataComplete ? 'Completos' : 'Incompletos');
        })
        .catch(err => {
          console.error('[Checkout] Error al verificar datos:', err);
          customerDataComplete = false;
        });
    }
    
    // Interceptar el submit del formulario
    function handleCartSubmit(e) {
      const p = getPreference();
      // Si el toggle no está activo, no hacer nada y dejar que el submit continúe normalmente
      if (!p.wantsInvoice) {
        return;
      }
      
      // Si el toggle está activo, validar antes de permitir checkout
      if (IS_LOGGED_IN) {
        // Si ya sabemos que los datos están completos, permitir el submit
        if (customerDataComplete === true) {
          console.log('[Checkout] Permitido: Datos completos (verificado previamente)');
          return; // No prevenir el default, dejar que el submit continúe
        }
        
        // Si sabemos que están incompletos, bloquear
        if (customerDataComplete === false) {
          console.log('[Checkout] Bloqueado: Datos incompletos (verificado previamente)');
          e.preventDefault();
          e.stopPropagation();
          openModal(true);
          setTimeout(() => {
            loadCustomerData();
            const form = document.getElementById('custom-invoice-form');
            if (form) {
              form.classList.add('submitted');
            }
          }, 100);
          return;
        }
        
        // Si aún no sabemos el estado, verificar ahora
        e.preventDefault();
        e.stopPropagation();
        
        fetch(`${API_BASE}/get?customer_id=${CUSTOMER_ID}`)
          .then(r => r.json())
          .then(d => {
            customerDataComplete = d.complete && d.customer;
            if (!d.complete || !d.customer) {
              console.log('[Checkout] Bloqueado en submit: Datos incompletos');
              openModal(true);
              setTimeout(() => {
                loadCustomerData();
                const form = document.getElementById('custom-invoice-form');
                if (form) {
                  form.classList.add('submitted');
                  const allFields = form.querySelectorAll('input[required], select[required]');
                  allFields.forEach(field => {
                    if (!field.value || (field.value && field.value.trim() === '')) {
                      const fieldId = field.id;
                      if (fieldId) {
                        showFormError(fieldId, 'Este campo es requerido');
                      }
                    }
                  });
                }
              }, 100);
            } else {
              console.log('[Checkout] Permitido en submit: Datos completos');
              // Si los datos están completos, remover el listener y permitir el submit
              cartForm.removeEventListener('submit', handleCartSubmit);
              // Redirigir directamente al checkout
              window.location.href = '/checkout';
            }
          })
          .catch(err => {
            console.error('Error:', err);
            customerDataComplete = false;
            openModal(true);
            setTimeout(() => {
              loadCustomerData();
              const form = document.getElementById('custom-invoice-form');
              if (form) {
                form.classList.add('submitted');
              }
            }, 100);
          });
      } else {
        e.preventDefault();
        e.stopPropagation();
        openModal(true);
        setTimeout(() => {
          const form = document.getElementById('custom-invoice-form');
          if (form) {
            form.classList.add('submitted');
            const allFields = form.querySelectorAll('input[required], select[required]');
            allFields.forEach(field => {
              if (!field.value || (field.value && field.value.trim() === '')) {
                const fieldId = field.id;
                if (fieldId) {
                  showFormError(fieldId, 'Este campo es requerido');
                }
              }
            });
          }
        }, 100);
      }
    }
    
    cartForm.addEventListener('submit', handleCartSubmit);
  }

  function getCheckoutButton() {
    // Buscar el botón específico por ID primero
    let cb = document.getElementById('checkout');
    if (cb) return cb;
    
    // Buscar por name="checkout"
    cb = document.querySelector('button[name="checkout"], input[name="checkout"]');
    if (cb) return cb;
    
    // Buscar en el formulario del carrito
    const cartForm = document.getElementById('cart') || document.querySelector('form[id*="cart"], form[action*="checkout"], form[action*="/checkout"]');
    if (cartForm) {
      cb = cartForm.querySelector('button[type="submit"][name="checkout"], button#checkout, button[name="checkout"]');
      if (cb) return cb;
      
      // Fallback: cualquier botón submit en el formulario
      cb = cartForm.querySelector('button[type="submit"], input[type="submit"]');
      if (cb) return cb;
    }
    
    // Buscar botones asociados al formulario mediante form="cart"
    cb = document.querySelector('button[form="cart"][name="checkout"], button[form="cart"]#checkout');
    if (cb) return cb;
    
    // Último fallback: buscar cualquier botón con checkout en el texto o href
    return document.querySelector('button[name*="checkout"], a[href*="checkout"]');
  }

  function checkCheckoutButton() {
    const cb = getCheckoutButton();
    if (!cb) {
      setTimeout(checkCheckoutButton, 500);
      return;
    }
    
    const p = getPreference();
    if (p.wantsInvoice) {
      if (IS_LOGGED_IN) {
        // Verificar datos sin abrir modal automáticamente
        loadCustomerDataOnInit();
      } else {
        disableCheckout();
        console.log('[Checkout] Bloqueado: Usuario no logueado y toggle activo');
      }
    } else {
      enableCheckout();
      console.log('[Checkout] Habilitado: Toggle inactivo');
    }
  }

  function disableCheckout() {
    const cb = getCheckoutButton();
    if (!cb) return;
    
    // No deshabilitar completamente, solo visualmente, para que pueda abrir el modal
      cb.style.opacity = '0.6';
    cb.style.cursor = 'pointer';
    cb.style.position = 'relative';
    cb.setAttribute('data-checkout-blocked', 'true');
    cb.setAttribute('aria-disabled', 'true');
    cb.setAttribute('title', 'Complete el formulario de factura personalizada para continuar');
    
    // Agregar listener para abrir modal al hacer click
    if (!cb.hasAttribute('data-modal-listener-added')) {
      cb.setAttribute('data-modal-listener-added', 'true');
      cb.addEventListener('click', handleBlockedCheckoutClick);
    }
    
    // Agregar indicador visual (opcional - un pequeño badge o tooltip)
    if (!cb.querySelector('.checkout-blocked-indicator')) {
      const indicator = document.createElement('span');
      indicator.className = 'checkout-blocked-indicator';
      indicator.textContent = '⚠';
      indicator.style.cssText = 'position: absolute; top: -8px; right: -8px; background: #ff6b6b; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; z-index: 10;';
      cb.style.position = 'relative';
      cb.appendChild(indicator);
    }
  }
  
  function handleBlockedCheckoutClick(e) {
    const cb = getCheckoutButton();
    if (!cb) return;
    
    const isBlocked = cb.getAttribute('data-checkout-blocked') === 'true';
    if (isBlocked) {
      e.preventDefault();
      e.stopPropagation();
      
      const p = getPreference();
      if (p.wantsInvoice) {
        // Abrir el modal y marcar para mostrar errores
        openModal(true);
        
        // Marcar el formulario como "submitted" para mostrar errores
        setTimeout(() => {
          const form = document.getElementById('custom-invoice-form');
          if (form) {
            form.classList.add('submitted');
            // Validar todos los campos para mostrar qué falta
            const allFields = form.querySelectorAll('input[required], select[required]');
            allFields.forEach(field => {
              if (!field.value || (field.value && field.value.trim() === '')) {
                const fieldId = field.id;
                if (fieldId) {
                  showFormError(fieldId, 'Este campo es requerido');
                }
              }
            });
          }
        }, 100);
        
        // Si el usuario no está logueado, mostrar mensaje en el modal
        if (!IS_LOGGED_IN) {
          // El modal ya mostrará el formulario de registro
        } else {
          // Cargar datos del cliente para mostrar el formulario
          loadCustomerData();
        }
      }
    }
  }
  
  function showFormError(fieldId, message) {
    const field = document.getElementById(fieldId);
    const errorElement = document.getElementById(`${fieldId}_error`);
    
    if (field) {
      field.classList.add('error');
    }
    
    if (errorElement) {
      errorElement.textContent = message;
      errorElement.classList.add('show');
    }
  }

  function enableCheckout() {
    const cb = getCheckoutButton();
    if (!cb) return;
    
      cb.disabled = false;
      cb.style.opacity = '1';
      cb.style.cursor = 'pointer';
    cb.removeAttribute('aria-disabled');
    cb.removeAttribute('data-checkout-blocked');
    cb.removeAttribute('title');
    
    // Remover indicador visual
    const indicator = cb.querySelector('.checkout-blocked-indicator');
    if (indicator) {
      indicator.remove();
    }
    
      if (cb.tagName === 'A') {
        cb.style.pointerEvents = 'auto';
    }
  }

  function loadCustomerData() {
    if (IS_LOGGED_IN) {
      const skeleton = document.getElementById('form-skeleton-loader');
      const dd = document.getElementById('customer-data-display');
      const fd = document.getElementById('customer-form-container');
      const actionCancelBtn = document.getElementById('action-cancel-btn');
      const actionUpdateBtn = document.getElementById('action-update-btn');
      
      // PRIMERO: Ocultar inmediatamente cualquier formulario o resumen visible
      if (dd) {
        dd.style.display = 'none';
        dd.style.opacity = '0';
      }
      if (fd) {
        fd.style.display = 'none';
        fd.style.opacity = '0';
      }
      
      // DESPUÉS: Mostrar skeleton loader
      if (skeleton) {
        skeleton.style.display = 'block';
        skeleton.style.opacity = '0';
        requestAnimationFrame(() => {
          skeleton.style.opacity = '1';
          // Animar altura cuando se muestra el skeleton
          setTimeout(() => {
            animateModalHeight();
          }, 50);
        });
      }
      
      // Deshabilitar botones mientras carga
      if (actionCancelBtn) actionCancelBtn.disabled = true;
      if (actionUpdateBtn) actionUpdateBtn.disabled = true;
      
      fetch(`${API_BASE}/get?customer_id=${CUSTOMER_ID}`)
        .then(r => r.json())
        .then(d => {
          // Ocultar skeleton con fade out
          if (skeleton) {
            skeleton.style.opacity = '0';
            setTimeout(() => {
              skeleton.style.display = 'none';
              // Animar altura después de ocultar el skeleton
              animateModalHeight();
            }, 300);
          } else {
            // Si no hay skeleton, animar altura de inmediato
            setTimeout(() => {
              animateModalHeight();
            }, 50);
          }
          // Habilitar botones cuando los datos estén cargados
          if (actionCancelBtn) actionCancelBtn.disabled = false;
          if (actionUpdateBtn) actionUpdateBtn.disabled = false;
          // Siempre mostrar el formulario directamente, sin mostrar el resumen
          showUpdateForm(d.customer);
        })
        .catch(e => {
          console.error('Error:', e);
          // Ocultar skeleton incluso si hay error
          if (skeleton) {
            skeleton.style.opacity = '0';
            setTimeout(() => {
              skeleton.style.display = 'none';
            }, 300);
          }
          // Habilitar botones incluso si hay error
          if (actionCancelBtn) actionCancelBtn.disabled = false;
          if (actionUpdateBtn) actionUpdateBtn.disabled = false;
          showUpdateForm();
        });
    }
  }

  function showCustomerData(c) {
    // Mostrar directamente el formulario sin mostrar el resumen
    showUpdateForm(c);
  }

  function animateModalHeight() {
    const modal = document.getElementById('custom-invoice-modal');
    const modalContent = document.querySelector('.custom-invoice-modal-content');
    if (!modal || !modalContent) return;
    
    // Calcular nueva altura: altura del contenido + altura del action-container
    const actionContainer = document.querySelector('.action-container');
    const contentHeight = modalContent.scrollHeight;
    const actionHeight = actionContainer ? actionContainer.offsetHeight : 0;
    const newHeight = contentHeight + actionHeight;
    
    // Obtener altura actual del modal (si no tiene altura asignada, usar la actual)
    const currentHeight = modal.style.height ? parseInt(modal.style.height) : modal.offsetHeight;
    
    // Si las alturas son diferentes, animar
    if (Math.abs(currentHeight - newHeight) > 1) {
      // Establecer altura inicial explícitamente para que la transición funcione
      if (!modal.style.height) {
        modal.style.height = currentHeight + 'px';
      }
      
      // Forzar reflow
      void modal.offsetHeight;
      
      // Establecer nueva altura y dejar que la transición CSS haga el trabajo
      requestAnimationFrame(() => {
        modal.style.height = newHeight + 'px';
        
        // Después de la transición, mantener la altura para futuras animaciones
        // No restaurar a 'auto' para que las transiciones sigan funcionando
      });
    } else if (!modal.style.height) {
      // Si no hay diferencia pero no tiene altura asignada, asignarla
      modal.style.height = newHeight + 'px';
    }
  }

  function showUpdateForm(c) {
    const dd = document.getElementById('customer-data-display');
    const fd = document.getElementById('customer-form-container');
    const actionUpdateBtn = document.getElementById('action-update-btn');
    
    // Restaurar el texto del botón cuando se muestra el formulario
    // Si el usuario está logueado, mostrar "Actualizar", si no, mostrar "Registrarse"
    if (actionUpdateBtn) {
      actionUpdateBtn.disabled = false;
      actionUpdateBtn.textContent = IS_LOGGED_IN ? 'Actualizar' : 'Registrarse';
    }
    
    if (dd) {
      dd.style.opacity = '0';
      setTimeout(() => { dd.style.display = 'none'; }, 300);
    }
    
    if (fd) {
      fd.style.display = 'block';
      fd.style.opacity = '0';
      // Usar requestAnimationFrame para asegurar que el display: block se aplique primero
      requestAnimationFrame(() => {
        fd.style.opacity = '1';
        // Animar altura después de que el contenido sea visible
        setTimeout(() => {
          animateModalHeight();
        }, 50);
      });
    }
    
    if (c && c.metafields) {
      populateForm(c);
      // Animar altura después de poblar el formulario
      setTimeout(() => {
        animateModalHeight();
      }, 100);
    } else {
      // Animar altura incluso si no hay datos
      setTimeout(() => {
        animateModalHeight();
      }, 100);
    }
  }
  
  function populateForm(c) {
    const mf = c.metafields || {};
    const f = document.getElementById('custom-invoice-form');
    if (!f) return;
    
    // Campos básicos
    const firstNameField = document.getElementById('first_name');
    const lastNameField = document.getElementById('last_name');
    const emailField = document.getElementById('email');
    const birthDateField = document.getElementById('birth_date');
    const genderField = document.getElementById('gender');
    const phoneField = document.getElementById('phone');
    
    if (firstNameField && c.firstName) firstNameField.value = c.firstName;
    if (lastNameField && c.lastName) lastNameField.value = c.lastName;
    if (emailField && c.email) emailField.value = c.email;
    // Poblar campos de fecha de nacimiento (día, mes, año)
    if (mf.ex_birthday) {
      const birthDateStr = mf.ex_birthday;
      // Parsear la fecha (formato YYYY-MM-DD)
      const dateParts = birthDateStr.split('-');
      if (dateParts.length === 3) {
        const year = dateParts[0];
        const month = dateParts[1];
        const day = dateParts[2];
        
        const birthDay = document.getElementById('birth_day');
        const birthMonth = document.getElementById('birth_month');
        const birthYear = document.getElementById('birth_year');
        
        if (birthDay) birthDay.value = String(parseInt(day, 10));
        if (birthMonth) birthMonth.value = month;
        if (birthYear) birthYear.value = year;
        
        // Actualizar el campo hidden
        updateBirthDateField();
      }
    }
    if (genderField && mf.ex_gender) genderField.value = mf.ex_gender;
    if (phoneField && mf.ex_phone) phoneField.value = mf.ex_phone;
    
    // Campos de facturación según tipo de cliente
    const customerType = mf.ex_customer_type;
    
    // País - determinar desde customer_type
    const countryField = document.getElementById('country');
    if (countryField) {
      // Esperar a que las opciones estén cargadas antes de establecer el valor
      const setCountryValue = () => {
        // Verificar que el select tenga opciones cargadas
        if (countryField.options.length <= 1) {
          // Si aún no hay opciones (solo la opción por defecto), esperar un poco más
          setTimeout(setCountryValue, 50);
          return;
        }
        
        // Si customer_type es 04, es extranjero (no Panamá)
        // Si es 01 o 02, es Panamá
        let countryValue = '';
        if (customerType === '04') {
          // Es extranjero, pero no guardamos el país
          // Establecer un país diferente a Panamá para mostrar campos de extranjero
          // Usar el primer país que no sea Panamá
          const nonPanamaCountry = COUNTRIES.find(c => c !== 'Panamá') || COUNTRIES[0];
          countryValue = nonPanamaCountry;
        } else {
          // 01 o 02 significa Panamá
          countryValue = 'Panamá';
        }
        
        // Verificar que el valor existe en las opciones antes de establecerlo
        const optionExists = Array.from(countryField.options).some(opt => opt.value === countryValue);
        if (optionExists) {
          countryField.value = countryValue;
          // Disparar evento change para asegurar que el select reconozca el valor
          countryField.dispatchEvent(new Event('change', { bubbles: true }));
          // Limpiar cualquier error del campo
          clearFormError(countryField);
          // Llamar a handleCountryChange después de establecer el valor
          setTimeout(() => {
            handleCountryChange();
          }, 50);
        } else {
          // Si el valor no existe, intentar de nuevo después de un delay
          setTimeout(setCountryValue, 50);
        }
      };
      
      // Iniciar el proceso de establecer el valor
      setCountryValue();
    }
    
    if (customerType === '04') {
      // Extranjero
      const taxIdForeign = document.getElementById('tax_id_foreign');
      const customerTypeForeign = document.getElementById('customer_type_foreign');
      if (taxIdForeign && mf.ex_tax_id) taxIdForeign.value = mf.ex_tax_id;
      if (customerTypeForeign) customerTypeForeign.value = '04';
    } else if (customerType === '01' || customerType === '02') {
      // Panamá - Contribuyente o Consumidor final
      const customerTypeField = document.getElementById('customer_type');
      if (customerTypeField) {
        customerTypeField.value = customerType;
        handleCustomerTypeChange();
      }
      
      if (customerType === '01') {
        // Contribuyente
        const taxIdContribuyente = document.getElementById('tax_id_contribuyente');
        const customerDv = document.getElementById('customer_dv');
        const taxpayerNameContribuyente = document.getElementById('taxpayer_name_contribuyente');
        const taxpayerKindContribuyente = document.getElementById('taxpayer_kind_contribuyente');
        
        if (taxIdContribuyente && mf.ex_tax_id) taxIdContribuyente.value = mf.ex_tax_id;
        if (customerDv && mf.ex_customer_dv) customerDv.value = mf.ex_customer_dv;
        if (taxpayerNameContribuyente && mf.ex_taxpayer_name) taxpayerNameContribuyente.value = mf.ex_taxpayer_name;
        if (taxpayerKindContribuyente && mf.ex_taxpayer_kind) taxpayerKindContribuyente.value = mf.ex_taxpayer_kind;
      } else if (customerType === '02') {
        // Consumidor final
        const taxIdConsumidor = document.getElementById('tax_id_consumidor');
        const taxpayerNameConsumidor = document.getElementById('taxpayer_name_consumidor');
        const taxpayerKindConsumidor = document.getElementById('taxpayer_kind_consumidor');
        
        if (taxIdConsumidor && mf.ex_tax_id) taxIdConsumidor.value = mf.ex_tax_id;
        if (taxpayerNameConsumidor && mf.ex_taxpayer_name) taxpayerNameConsumidor.value = mf.ex_taxpayer_name;
        if (taxpayerKindConsumidor && mf.ex_taxpayer_kind) taxpayerKindConsumidor.value = mf.ex_taxpayer_kind;
      }
      
      // Campos de ubicación (solo para Panamá)
      const provinceField = document.getElementById('province');
      const districtField = document.getElementById('district');
      const corregimientoField = document.getElementById('corregimiento');
      
      // Por ahora usar "test" como valor temporal
      if (provinceField) provinceField.value = 'test';
      if (districtField) districtField.value = 'test';
      if (corregimientoField) corregimientoField.value = 'test';
      
      // Actualizar Razón Social si es consumidor final
      if (customerType === '02') {
        setTimeout(() => {
          updateRazonSocial();
        }, 100);
      }
    }
  }
  

  function handleStorageChange(e) {
    if (e.key === STORAGE_KEY) {
      const p = getPreference();
      toggle.setAttribute('aria-checked', String(p.wantsInvoice));
      updateToggleText();
      checkCheckoutButton();
    }
  }

  window.enableCheckoutAfterUpdate = function() {
    enableCheckout();
    savePreference({ wantsInvoice: true, dataComplete: true });
  };

  window.getLoginUrl = function() {
    // routes.storefront_login_url ya maneja automáticamente el return_to
    // No agregamos parámetros adicionales para evitar problemas de autenticación
    return LOGIN_URL;
  };

  // ===== CÓDIGO DEL FORMULARIO =====
  function initForm() {
    const form = document.getElementById('custom-invoice-form');
    if (!form) return;
    
    // Cargar países en el select
    const countrySelect = document.getElementById('country');
    if (countrySelect) {
      COUNTRIES.forEach(country => {
        const option = document.createElement('option');
        option.value = country;
        option.textContent = country;
        if (country === 'Panamá') {
          option.selected = true;
        }
        countrySelect.appendChild(option);
      });
      
      // Manejar cambio de país
      countrySelect.addEventListener('change', handleCountryChange);
      handleCountryChange(); // Ejecutar al inicio
    }
    
    // Manejar cambio de tipo de cliente (solo para Panamá)
    const customerTypeSelect = document.getElementById('customer_type');
    if (customerTypeSelect) {
      customerTypeSelect.addEventListener('change', handleCustomerTypeChange);
    }
    
    // Auto-completar Razón Social cuando cambian Nombre o Apellido
    const firstNameInput = document.getElementById('first_name');
    const lastNameInput = document.getElementById('last_name');
    const taxpayerNameConsumidor = document.getElementById('taxpayer_name_consumidor');
    
    if (firstNameInput) {
      firstNameInput.addEventListener('input', updateRazonSocial);
    }
    if (lastNameInput) {
      lastNameInput.addEventListener('input', updateRazonSocial);
    }
    
    // Agregar listeners a los campos de fecha de nacimiento
    const birthDay = document.getElementById('birth_day');
    const birthMonth = document.getElementById('birth_month');
    const birthYear = document.getElementById('birth_year');
    
    // Función para actualizar el estilo del placeholder en selects
    function updateSelectPlaceholderStyle(select) {
      if (select && select.value === '') {
        select.style.color = '#b3b3b3';
      } else if (select) {
        select.style.color = '#000';
      }
    }
    
    if (birthDay) {
      birthDay.addEventListener('change', function() {
        updateBirthDateField();
        updateSelectPlaceholderStyle(birthDay);
      });
      updateSelectPlaceholderStyle(birthDay);
    }
    if (birthMonth) {
      birthMonth.addEventListener('change', function() {
        updateBirthDateField();
        updateSelectPlaceholderStyle(birthMonth);
      });
      updateSelectPlaceholderStyle(birthMonth);
    }
    if (birthYear) {
      birthYear.addEventListener('change', function() {
        updateBirthDateField();
        updateSelectPlaceholderStyle(birthYear);
      });
      updateSelectPlaceholderStyle(birthYear);
    }
    
    // Aplicar estilo de placeholder a todos los selects
    const allSelects = form.querySelectorAll('select.custom-invoice-input');
    allSelects.forEach(select => {
      updateSelectPlaceholderStyle(select);
      select.addEventListener('change', function() {
        updateSelectPlaceholderStyle(select);
      });
    });
    
    // Validar que celular no tenga guiones y solo números
    const phoneInput = document.getElementById('phone');
    if (phoneInput) {
      phoneInput.addEventListener('input', function(e) {
        console.log('[DEBUG PHONE INPUT] Evento input disparado');
        console.log('[DEBUG PHONE INPUT] Valor antes de limpiar:', e.target.value);
        
        // Limpiar cualquier carácter que no sea número
        const cleanValue = e.target.value.replace(/[^0-9]/g, '');
        console.log('[DEBUG PHONE INPUT] Valor después de limpiar:', cleanValue);
        console.log('[DEBUG PHONE INPUT] Longitud:', cleanValue.length);
        
        if (e.target.value !== cleanValue) {
          e.target.value = cleanValue;
          console.log('[DEBUG PHONE INPUT] Campo actualizado con valor limpio');
        }
        
        // Limpiar error si el campo tiene valor válido (8 dígitos exactos)
        if (cleanValue.length === 8) {
          console.log('[DEBUG PHONE INPUT] Limpiando error - campo válido (8 dígitos)');
          clearFormError(e.target);
        } else {
          console.log('[DEBUG PHONE INPUT] Campo no válido aún - longitud:', cleanValue.length);
        }
      });
    }
    
    if (form) form.addEventListener('submit', handleSubmit);
    
    // Agregar listeners a los botones del action-container
    const actionCancelBtn = document.getElementById('action-cancel-btn');
    if (actionCancelBtn) {
      actionCancelBtn.addEventListener('click', function(e) {
        e.preventDefault();
        closeModal();
      });
    }
    
    const actionUpdateBtn = document.getElementById('action-update-btn');
    if (actionUpdateBtn) {
      actionUpdateBtn.addEventListener('click', function(e) {
        e.preventDefault();
        // Disparar el submit del formulario directamente
        const form = document.getElementById('custom-invoice-form');
        if (form) {
          // Disparar el evento submit del formulario, que será manejado por handleSubmit
          form.requestSubmit();
        }
      });
    }
    
    const inputs = form.querySelectorAll('input,select');
    let formSubmitted = false;
    
    inputs.forEach((i) => {
      // Solo validar en blur si el formulario ya fue intentado enviar
      i.addEventListener('blur', () => {
        if (formSubmitted) {
          validateField(i);
        }
        // Si es un campo de fecha, actualizar el campo hidden
        if (i.id === 'birth_day' || i.id === 'birth_month' || i.id === 'birth_year') {
          updateBirthDateField();
        }
      });
      i.addEventListener('input', () => {
        clearFormError(i);
        // Si el usuario empieza a escribir, validar en tiempo real
        if (formSubmitted) {
          validateField(i);
        }
      });
      i.addEventListener('change', () => {
        // Si es un campo de fecha, actualizar el campo hidden
        if (i.id === 'birth_day' || i.id === 'birth_month' || i.id === 'birth_year') {
          updateBirthDateField();
          if (formSubmitted) {
            const birthDateField = document.getElementById('birth_date');
            if (birthDateField) validateField(birthDateField);
          }
        }
      });
    });
    
    // Marcar cuando el formulario ha sido intentado enviar
    form.addEventListener('submit', function() {
      formSubmitted = true;
      form.classList.add('submitted');
    }, { once: true });
  }
  
  function handleCountryChange() {
    const country = document.getElementById('country')?.value;
    const billingSection = document.getElementById('billing-section');
    const foreignFields = document.getElementById('foreign-billing-fields');
    const panamaFields = document.getElementById('panama-billing-fields');
    
    if (!country) {
      if (billingSection) billingSection.style.display = 'none';
      return;
    }
    
    if (billingSection) billingSection.style.display = 'block';
    
    if (country === 'Panamá') {
      if (foreignFields) foreignFields.style.display = 'none';
      if (panamaFields) panamaFields.style.display = 'block';
      handleCustomerTypeChange(); // Actualizar campos según tipo de cliente
    } else {
      if (foreignFields) foreignFields.style.display = 'block';
      if (panamaFields) panamaFields.style.display = 'none';
      // Para extranjero, establecer automáticamente el tipo
      const customerTypeForeign = document.getElementById('customer_type_foreign');
      if (customerTypeForeign) customerTypeForeign.value = '04';
    }
  }
  
  function handleCustomerTypeChange() {
    const customerType = document.getElementById('customer_type')?.value;
    const contribuyenteFields = document.getElementById('contribuyente-fields');
    const consumidorFields = document.getElementById('consumidor-fields');
    
    if (customerType === '01') {
      // Contribuyente
      if (contribuyenteFields) contribuyenteFields.style.display = 'block';
      if (consumidorFields) consumidorFields.style.display = 'none';
    } else if (customerType === '02') {
      // Consumidor final
      if (contribuyenteFields) contribuyenteFields.style.display = 'none';
      if (consumidorFields) consumidorFields.style.display = 'block';
      // Actualizar Razón Social cuando se muestra el campo
      setTimeout(() => {
        updateRazonSocial();
      }, 50);
    } else {
      // Ninguno seleccionado
      if (contribuyenteFields) contribuyenteFields.style.display = 'none';
      if (consumidorFields) consumidorFields.style.display = 'none';
    }
  }
  
  function updateRazonSocial() {
    // Solo actualizar si es consumidor final y el campo está visible
    const customerType = document.getElementById('customer_type')?.value;
    if (customerType !== '02') return; // Solo para consumidor final
    
    const firstName = document.getElementById('first_name')?.value || '';
    const lastName = document.getElementById('last_name')?.value || '';
    const taxpayerNameConsumidor = document.getElementById('taxpayer_name_consumidor');
    
    if (taxpayerNameConsumidor) {
      const razonSocial = `${firstName} ${lastName}`.trim().toUpperCase();
      // Solo actualizar si el campo está vacío o si el usuario no lo ha modificado manualmente
      // Por ahora, siempre actualizamos cuando cambian nombre/apellido
      taxpayerNameConsumidor.value = razonSocial;
    }
  }


  function validateEmail(e) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e);
  }

  function validateName(n) {
    return /^[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+$/.test(n) && n.trim().length >= 1;
  }

  function validateField(f) {
    const id = f.id;
    const v = f.value.trim();
    if (f.required && !v) {
      showFormError(id, 'Requerido');
      return false;
    }
    switch (id) {
      case 'email':
        if (v && !validateEmail(v)) {
          showFormError(id, 'Email inválido');
          return false;
        }
        break;
      case 'first_name':
      case 'last_name':
        if (v && !validateName(v)) {
          showFormError(id, 'Solo letras');
          return false;
        }
        break;
      case 'phone':
        console.log('[DEBUG PHONE] Iniciando validación de teléfono');
        console.log('[DEBUG PHONE] Valor original (v):', v);
        console.log('[DEBUG PHONE] Valor original tipo:', typeof v);
        console.log('[DEBUG PHONE] Campo requerido:', f.required);
        console.log('[DEBUG PHONE] Campo completo:', f);
        
        // Validar que no esté vacío si es requerido (ya se validó arriba)
        if (!v && f.required) {
          console.log('[DEBUG PHONE] Campo vacío y requerido - retornando false');
          return false; // Ya se mostró el error de "Requerido"
        }
        
        // Si tiene valor, validar formato
        if (v) {
          console.log('[DEBUG PHONE] Campo tiene valor, validando formato');
          
          // Limpiar espacios y caracteres no numéricos
          const cleanValue = v.replace(/[\s\-\(\)]/g, '');
          console.log('[DEBUG PHONE] Valor limpio:', cleanValue);
          console.log('[DEBUG PHONE] Longitud del valor limpio:', cleanValue.length);
          
          // Validar que solo tenga números
          const isNumeric = /^[0-9]+$/.test(cleanValue);
          console.log('[DEBUG PHONE] ¿Es numérico?', isNumeric);
          
          if (!isNumeric) {
            console.log('[DEBUG PHONE] ERROR: No es numérico');
            showFormError(id, 'Solo números');
            return false;
          }
          
          // Si el valor limpio es diferente, actualizar el campo
          if (v !== cleanValue) {
            console.log('[DEBUG PHONE] Actualizando campo con valor limpio');
            f.value = cleanValue;
          }
          
          // Validar longitud - debe ser exactamente 8 dígitos
          console.log('[DEBUG PHONE] Validando longitud:', cleanValue.length);
          if (cleanValue.length !== 8) {
            console.log('[DEBUG PHONE] ERROR: Longitud incorrecta. Esperado: 8, Obtenido:', cleanValue.length);
            showFormError(id, 'El celular debe tener exactamente 8 dígitos');
            return false;
          }
          
          // Si llegamos aquí, el campo es válido
          console.log('[DEBUG PHONE] ✓ Campo válido');
          clearFormError(f);
        } else {
          console.log('[DEBUG PHONE] Campo sin valor');
        }
        break;
      case 'gender':
        if (v && !['M', 'F', 'X'].includes(v)) {
          showFormError(id, 'Valor inválido');
          return false;
        }
        break;
      case 'birth_date':
        if (v) {
          const date = new Date(v);
          const today = new Date();
          if (isNaN(date.getTime())) {
            showFormError(id, 'Fecha inválida');
            return false;
          }
          if (date > today) {
            showFormError(id, 'La fecha de nacimiento no puede ser futura');
            return false;
          }
        }
        break;
      case 'country':
        // Validar que el país esté seleccionado y sea válido
        if (v && !COUNTRIES.includes(v)) {
          showFormError(id, 'País inválido');
          return false;
        }
        break;
      case 'customer_type':
        if (v && !['01', '02'].includes(v)) {
          showFormError(id, 'Valor inválido');
          return false;
        }
        break;
      case 'taxpayer_kind_contribuyente':
      case 'taxpayer_kind_consumidor':
        if (v && !['1', '2'].includes(v)) {
          showFormError(id, 'Valor inválido');
          return false;
        }
        break;
    }
    clearFormError(f);
    return true;
  }

  function validateForm() {
    const form = document.getElementById('custom-invoice-form');
    if (!form) return false;
    
    // Marcar el formulario como submitted para mostrar errores visuales
    form.classList.add('submitted');
    
    // Limpiar todos los errores previos
    const allFields = form.querySelectorAll('.custom-invoice-input');
    allFields.forEach(field => {
      clearFormError(field);
    });
    
    let valid = true;
    const errorFields = [];
    
    // Validar campos básicos siempre requeridos
    const basicFields = ['first_name', 'last_name', 'email', 'gender', 'phone', 'country'];
    basicFields.forEach(fieldId => {
      const field = document.getElementById(fieldId);
      if (field && field.required) {
        // Para el campo country, verificar que tenga un valor válido
        if (fieldId === 'country') {
          const countryValue = field.value;
          if (!countryValue || countryValue.trim() === '' || countryValue === 'Seleccione un país') {
            showFormError(fieldId, 'Este campo es requerido');
            valid = false;
            errorFields.push(field);
          } else if (!COUNTRIES.includes(countryValue)) {
            showFormError(fieldId, 'País inválido');
            valid = false;
            errorFields.push(field);
          } else {
            // El país es válido, limpiar cualquier error
            clearFormError(field);
          }
        } else {
          // Para otros campos, usar la validación normal
          if (!validateField(field)) {
            valid = false;
            errorFields.push(field);
          }
        }
      }
    });
    
    // Validar campos de fecha de nacimiento (día, mes, año)
    const birthDay = document.getElementById('birth_day');
    const birthMonth = document.getElementById('birth_month');
    const birthYear = document.getElementById('birth_year');
    
    if (birthDay && birthDay.required && !birthDay.value) {
      showFormError('birth_date', 'Fecha de nacimiento requerida');
      valid = false;
      errorFields.push(birthDay);
    }
    if (birthMonth && birthMonth.required && !birthMonth.value) {
      showFormError('birth_date', 'Fecha de nacimiento requerida');
      valid = false;
      if (!errorFields.includes(birthMonth)) errorFields.push(birthMonth);
    }
    if (birthYear && birthYear.required && !birthYear.value) {
      showFormError('birth_date', 'Fecha de nacimiento requerida');
      valid = false;
      if (!errorFields.includes(birthYear)) errorFields.push(birthYear);
    }
    
    // Si todos los campos de fecha están completos, validar la fecha combinada
    if (birthDay && birthMonth && birthYear && birthDay.value && birthMonth.value && birthYear.value) {
      updateBirthDateField();
      const birthDateField = document.getElementById('birth_date');
      if (birthDateField && birthDateField.value) {
        // Validar que la fecha sea válida
        const date = new Date(birthDateField.value);
        const today = new Date();
        if (isNaN(date.getTime())) {
          showFormError('birth_date', 'Fecha inválida');
          valid = false;
        } else if (date > today) {
          showFormError('birth_date', 'La fecha de nacimiento no puede ser futura');
          valid = false;
        } else {
          clearFormError(birthDateField);
        }
      }
    }
    
    // Validar campos condicionales según país y tipo de cliente
    const country = document.getElementById('country')?.value;
    
    if (country && country !== 'Panamá') {
      // Extranjero
      const taxIdForeign = document.getElementById('tax_id_foreign');
      if (taxIdForeign && !taxIdForeign.value.trim()) {
        showFormError('tax_id_foreign', 'Este campo es requerido');
        valid = false;
        errorFields.push(taxIdForeign);
      }
    } else if (country === 'Panamá') {
      // Panamá
      const customerType = document.getElementById('customer_type')?.value;
      if (!customerType) {
        showFormError('customer_type', 'Este campo es requerido');
        valid = false;
        const customerTypeField = document.getElementById('customer_type');
        if (customerTypeField) errorFields.push(customerTypeField);
      } else if (customerType === '01') {
        // Contribuyente
        const contribuyenteFields = ['tax_id_contribuyente', 'customer_dv', 'taxpayer_name_contribuyente', 'taxpayer_kind_contribuyente'];
        contribuyenteFields.forEach(fieldId => {
          const field = document.getElementById(fieldId);
          if (field && !validateField(field)) {
            valid = false;
            errorFields.push(field);
          }
        });
      } else if (customerType === '02') {
        // Consumidor final
        const consumidorFields = ['tax_id_consumidor', 'taxpayer_kind_consumidor'];
        consumidorFields.forEach(fieldId => {
          const field = document.getElementById(fieldId);
          if (field && !validateField(field)) {
            valid = false;
            errorFields.push(field);
          }
        });
      }
      
      // Campos de ubicación (siempre requeridos para Panamá)
      const locationFields = ['province', 'district', 'corregimiento'];
      locationFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field && !validateField(field)) {
          valid = false;
          errorFields.push(field);
        }
      });
    }
    
    // Si hay errores, hacer scroll al primero
    if (!valid && errorFields.length > 0) {
      const firstError = errorFields[0];
      if (firstError) {
        // Hacer scroll al campo con error
        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setTimeout(() => {
          firstError.focus();
        }, 300);
      }
    }
    
    return valid;
  }

  function clearFormError(f) {
    if (!f) return;
    const id = f.id;
    const e = document.getElementById(`${id}_error`);
    if (f) f.classList.remove('error');
    if (e) {
      e.textContent = '';
      e.classList.remove('show');
    }
  }

  function showFormMsg(m, t) {
    const d = document.getElementById('form-message');
    if (d) {
      // Permitir HTML en el mensaje para formatear mejor
      d.innerHTML = m.replace(/\n/g, '<br>');
      d.className = `custom-invoice-message ${t}`;
      // Asegurar que los estilos inline tengan prioridad
      d.style.setProperty('visibility', 'visible', 'important');
      d.style.setProperty('opacity', '1', 'important');
      d.style.setProperty('display', 'block', 'important');
      // Hacer scroll al action-container para que el mensaje sea visible
      const actionContainer = document.querySelector('.action-container');
      if (actionContainer) {
        actionContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
      setTimeout(() => {
        d.style.setProperty('opacity', '0', 'important');
        setTimeout(() => {
          d.style.setProperty('visibility', 'hidden', 'important');
          d.style.setProperty('display', 'none', 'important');
          d.innerHTML = '';
        }, 300);
      }, 5000);
    } else {
      console.error('form-message element not found');
    }
  }

  function updateBirthDateField() {
    const day = document.getElementById('birth_day')?.value || '';
    const month = document.getElementById('birth_month')?.value || '';
    const year = document.getElementById('birth_year')?.value || '';
    const birthDateField = document.getElementById('birth_date');
    
    if (day && month && year && birthDateField) {
      // Formatear como YYYY-MM-DD
      const formattedDate = `${year}-${month}-${day.padStart(2, '0')}`;
      birthDateField.value = formattedDate;
    } else if (birthDateField) {
      birthDateField.value = '';
    }
  }

  function getFormData() {
    const form = document.getElementById('custom-invoice-form');
    if (!form) return null;
    
    const country = document.getElementById('country')?.value;
    const customerType = document.getElementById('customer_type')?.value;
    const customerTypeForeign = document.getElementById('customer_type_foreign')?.value;
    
    // Actualizar birth_date antes de obtener los datos
    updateBirthDateField();
    
    const d = {
      first_name: document.getElementById('first_name')?.value?.trim() || '',
      last_name: document.getElementById('last_name')?.value?.trim() || '',
      email: document.getElementById('email')?.value?.trim() || '',
      birth_date: document.getElementById('birth_date')?.value || '',
      gender: document.getElementById('gender')?.value || '',
      phone: document.getElementById('phone')?.value?.replace(/[^0-9]/g, '') || '',
      // country NO se guarda, solo se usa para lógica condicional
    };
    
    // Determinar tipo de cliente y campos de facturación
    let finalCustomerType = '';
    let documentNumber = '';
    let documentType = '';
    
    if (country !== 'Panamá') {
      finalCustomerType = customerTypeForeign || '04';
      documentNumber = document.getElementById('tax_id_foreign')?.value?.trim() || '';
      documentType = 'pasaporte'; // Extranjero usa pasaporte
    } else {
      finalCustomerType = customerType || '';
      d.customer_type = finalCustomerType;
      
      if (finalCustomerType === '01') {
        // Contribuyente
        documentNumber = document.getElementById('tax_id_contribuyente')?.value?.trim() || '';
        const customerDv = document.getElementById('customer_dv')?.value?.trim() || '';
        // Si tiene DV, es un RUC, de lo contrario es cédula
        if (customerDv) {
          documentType = 'ruc';
          d.customer_dv = customerDv;
        } else {
          documentType = 'cedula';
        }
        d.taxpayer_name = document.getElementById('taxpayer_name_contribuyente')?.value?.trim() || '';
        d.taxpayer_kind = document.getElementById('taxpayer_kind_contribuyente')?.value || '';
      } else if (finalCustomerType === '02') {
        // Consumidor final
        documentNumber = document.getElementById('tax_id_consumidor')?.value?.trim() || '';
        documentType = 'cedula'; // Consumidor final siempre usa cédula
        d.taxpayer_name = document.getElementById('taxpayer_name_consumidor')?.value?.trim() || '';
        d.taxpayer_kind = document.getElementById('taxpayer_kind_consumidor')?.value || '';
      }
      
      // Campos de ubicación (solo para Panamá)
      d.province = document.getElementById('province')?.value || '';
      d.district = document.getElementById('district')?.value || '';
      d.corregimiento = document.getElementById('corregimiento')?.value || '';
    }
    
    // Mapear tax_id a document_number y agregar document_type
    d.document_number = documentNumber;
    d.document_type = documentType;
    
    // Agregar código de país del teléfono
    // Para Panamá es +507, para otros países necesitaríamos un mapeo
    // Por ahora, si el país es Panamá, usar +507, de lo contrario usar +1 como default
    if (country === 'Panamá') {
      d.phone_country_code = '+507';
    } else {
      // Mapeo básico de códigos de país (puedes expandir esto según necesites)
      const countryCodes = {
        'Estados Unidos': '+1',
        'México': '+52',
        'Colombia': '+57',
        'España': '+34',
        // Agregar más países según sea necesario
      };
      d.phone_country_code = countryCodes[country] || '+507'; // Default a Panamá si no se encuentra
    }
    
    d.customer_type = finalCustomerType;
    
    // Agregar customer_id si existe (para actualización)
    const customerId = document.getElementById('customer_id')?.value;
    if (customerId) {
      d.customer_id = customerId;
    }
    
    return d;
  }

  async function handleSubmit(e) {
    e.preventDefault();
    const form = document.getElementById('custom-invoice-form');
    if (form) {
      form.classList.add('submitted');
    }
    
    if (!validateForm()) {
      showFormMsg('Complete todos los campos', 'error');
      // Hacer scroll al primer campo con error
      const firstError = form?.querySelector('.custom-invoice-input.error');
      if (firstError) {
        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        firstError.focus();
      }
      return;
    }
    const fd = getFormData();
    if (!fd) return;
    const actionUpdateBtn = document.getElementById('action-update-btn');
    const originalText = actionUpdateBtn ? actionUpdateBtn.textContent : '';
    if (actionUpdateBtn) {
      actionUpdateBtn.disabled = true;
      actionUpdateBtn.textContent = 'Procesando...';
    }
    const cid = document.getElementById('customer_id')?.value;
    const isUp = !!cid;
    try {
      // Usar la ruta correcta del app proxy
      // El app proxy mapea /apps/custom-invoice/* a /api/proxy/*
      const ep = isUp 
        ? `${API_BASE}/update` 
        : `${API_BASE}/create`;
      if (isUp) {
        fd.customer_id = cid;
      }
      const r = await fetch(ep, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(fd),
      });
      const res = await r.json();
      if (!r.ok || res.error) {
        // Si hay un error del backend, intentar parsear y mostrar en campos específicos
        const errorHandled = handleBackendError(res.error);
        const error = new Error(res.error || 'Error');
        error.handled = errorHandled;
        throw error;
      }
      if (isUp) {
        // Restaurar el botón inmediatamente después del éxito
        if (actionUpdateBtn) {
          actionUpdateBtn.disabled = false;
          actionUpdateBtn.textContent = originalText || 'Actualizar';
        }
        showFormMsg('Actualizado correctamente', 'success');
        setTimeout(() => {
          closeModal();
          enableCheckout();
          // Actualizar el resumen de datos si está visible
          if (IS_LOGGED_IN) {
            loadCustomerDataOnInit();
          }
          console.log('[Checkout] Habilitado: Datos actualizados correctamente');
        }, 1500);
      } else {
        // Restaurar el botón inmediatamente después del éxito (registro)
        if (actionUpdateBtn) {
          actionUpdateBtn.disabled = false;
          actionUpdateBtn.textContent = originalText || 'Registrarse';
        }
        const userEmail = fd.email; // El email que el usuario acaba de registrar
        // Mostrar el email en el mensaje para que el usuario lo tenga visible
        // Shopify no soporta pre-poblar el email en la página de login, así que lo mostramos aquí
        showFormMsg(`Registro exitoso. Redirigiendo al login...<br><strong>Tu email: ${userEmail}</strong><br>Úsalo para iniciar sesión.`, 'success');
        setTimeout(() => {
          let loginUrl;
          
          if (typeof window.getLoginUrl === 'function') {
            loginUrl = window.getLoginUrl();
          } else {
            const loginLink = document.getElementById('login-link');
            if (loginLink && loginLink.href) {
              loginUrl = loginLink.href;
            } else {
              // Usar routes.storefront_login_url que maneja automáticamente el return_to
              loginUrl = LOGIN_URL;
            }
          }
          if (loginUrl) {
            window.location.href = loginUrl;
          } else {
            console.error('No se pudo obtener la URL de login');
            closeModal();
          }
        }, 2000); // Aumentar el tiempo para que el usuario vea el email
      }
    } catch (err) {
      console.error('Error:', err);
      // El error ya fue manejado por handleBackendError si es un error de validación
      // Solo mostrar mensaje general si no se pudo mapear a campos específicos
      if (!err.handled) {
        showFormMsg(err.message || 'Error al procesar la solicitud', 'error');
      }
      if (actionUpdateBtn) {
        actionUpdateBtn.disabled = false;
        actionUpdateBtn.textContent = originalText;
      }
    }
  }
  
  function handleBackendError(errorMessage) {
    if (!errorMessage) return false;
    
    // Marcar el formulario como submitted para mostrar errores
    const form = document.getElementById('custom-invoice-form');
    if (form) {
      form.classList.add('submitted');
    }
    
    // Intentar mapear errores comunes a campos específicos
    const errorLower = errorMessage.toLowerCase();
    const errorFields = [];
    let fieldsMapped = false;
    
    // Mapear errores comunes a campos
    if (errorLower.includes('nombre') || errorLower.includes('first_name')) {
      showFormError('first_name', 'Nombre inválido o requerido');
      const field = document.getElementById('first_name');
      if (field) errorFields.push(field);
      fieldsMapped = true;
    }
    if (errorLower.includes('apellido') || errorLower.includes('last_name')) {
      showFormError('last_name', 'Apellido inválido o requerido');
      const field = document.getElementById('last_name');
      if (field) errorFields.push(field);
      fieldsMapped = true;
    }
    if (errorLower.includes('email')) {
      showFormError('email', 'Email inválido o requerido');
      const field = document.getElementById('email');
      if (field) errorFields.push(field);
      fieldsMapped = true;
    }
    if (errorLower.includes('fecha') || errorLower.includes('birth_date')) {
      showFormError('birth_date', 'Fecha de nacimiento inválida o requerida');
      const birthDay = document.getElementById('birth_day');
      const birthMonth = document.getElementById('birth_month');
      const birthYear = document.getElementById('birth_year');
      if (birthDay) {
        birthDay.classList.add('error');
        errorFields.push(birthDay);
      }
      if (birthMonth) {
        birthMonth.classList.add('error');
        if (!errorFields.includes(birthMonth)) errorFields.push(birthMonth);
      }
      if (birthYear) {
        birthYear.classList.add('error');
        if (!errorFields.includes(birthYear)) errorFields.push(birthYear);
      }
      fieldsMapped = true;
    }
    if (errorLower.includes('género') || errorLower.includes('gender')) {
      showFormError('gender', 'Género requerido');
      const field = document.getElementById('gender');
      if (field) errorFields.push(field);
      fieldsMapped = true;
    }
    if (errorLower.includes('celular') || errorLower.includes('phone')) {
      showFormError('phone', 'Celular inválido o requerido');
      const field = document.getElementById('phone');
      if (field) errorFields.push(field);
      fieldsMapped = true;
    }
    if (errorLower.includes('país') || errorLower.includes('country')) {
      showFormError('country', 'País requerido');
      const field = document.getElementById('country');
      if (field) errorFields.push(field);
      fieldsMapped = true;
    }
    if (errorLower.includes('tipo de cliente') || errorLower.includes('customer_type')) {
      showFormError('customer_type', 'Tipo de cliente requerido');
      const field = document.getElementById('customer_type');
      if (field) errorFields.push(field);
      fieldsMapped = true;
    }
    if (errorLower.includes('cédula') || errorLower.includes('ruc') || errorLower.includes('tax_id')) {
      const country = document.getElementById('country')?.value;
      if (country === 'Panamá') {
        const customerType = document.getElementById('customer_type')?.value;
        if (customerType === '01') {
          showFormError('tax_id_contribuyente', 'Cédula o RUC requerido');
          const field = document.getElementById('tax_id_contribuyente');
          if (field) errorFields.push(field);
          fieldsMapped = true;
        } else if (customerType === '02') {
          showFormError('tax_id_consumidor', 'Cédula requerida');
          const field = document.getElementById('tax_id_consumidor');
          if (field) errorFields.push(field);
          fieldsMapped = true;
        }
      } else {
        showFormError('tax_id_foreign', 'Pasaporte o Identificación requerido');
        const field = document.getElementById('tax_id_foreign');
        if (field) errorFields.push(field);
        fieldsMapped = true;
      }
    }
    if (errorLower.includes('dv') || errorLower.includes('customer_dv')) {
      showFormError('customer_dv', 'DV requerido');
      const field = document.getElementById('customer_dv');
      if (field) errorFields.push(field);
      fieldsMapped = true;
    }
    if (errorLower.includes('razón social') || errorLower.includes('taxpayer_name')) {
      const customerType = document.getElementById('customer_type')?.value;
      if (customerType === '01') {
        showFormError('taxpayer_name_contribuyente', 'Razón Social requerida');
        const field = document.getElementById('taxpayer_name_contribuyente');
        if (field) errorFields.push(field);
        fieldsMapped = true;
      }
    }
    if (errorLower.includes('tipo de contribuyente') || errorLower.includes('taxpayer_kind')) {
      const customerType = document.getElementById('customer_type')?.value;
      if (customerType === '01') {
        showFormError('taxpayer_kind_contribuyente', 'Tipo de Contribuyente requerido');
        const field = document.getElementById('taxpayer_kind_contribuyente');
        if (field) errorFields.push(field);
        fieldsMapped = true;
      } else if (customerType === '02') {
        showFormError('taxpayer_kind_consumidor', 'Tipo de Contribuyente requerido');
        const field = document.getElementById('taxpayer_kind_consumidor');
        if (field) errorFields.push(field);
        fieldsMapped = true;
      }
    }
    if (errorLower.includes('provincia') || errorLower.includes('province')) {
      showFormError('province', 'Provincia requerida');
      const field = document.getElementById('province');
      if (field) errorFields.push(field);
      fieldsMapped = true;
    }
    if (errorLower.includes('distrito') || errorLower.includes('district')) {
      showFormError('district', 'Distrito requerido');
      const field = document.getElementById('district');
      if (field) errorFields.push(field);
      fieldsMapped = true;
    }
    if (errorLower.includes('corregimiento')) {
      showFormError('corregimiento', 'Corregimiento requerido');
      const field = document.getElementById('corregimiento');
      if (field) errorFields.push(field);
      fieldsMapped = true;
    }
    
    // Si se mapearon errores a campos, hacer scroll al primero
    if (errorFields.length > 0) {
      const firstError = errorFields.find(f => f !== null);
      if (firstError) {
        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setTimeout(() => {
          firstError.focus();
        }, 300);
      }
      return true; // Indica que se mapearon errores a campos
    } else if (!fieldsMapped) {
      // Si no se pudo mapear, mostrar mensaje general
      showFormMsg(errorMessage, 'error');
      return false; // Indica que no se mapearon errores
    }
    
    return fieldsMapped;
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
{% endif %}

{% schema %}
{
  "name": "Factura Personalizada",
  "target": "section",
  "enabled_on": {
    "templates": ["cart"]
  },
  "stylesheet": "cart-form.css",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Título",
      "default": "¿Necesitas factura personalizada?"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Subtítulo",
      "default": "Completa tus datos para generar una factura personalizada"
    }
  ]
}
{% endschema %}
