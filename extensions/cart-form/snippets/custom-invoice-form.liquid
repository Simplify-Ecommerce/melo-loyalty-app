{% doc %}
  Formulario para registro/actualización de datos del cliente para factura personalizada.
  Reestructurado para usar metafields exchanger.
  
  @param {boolean} is_update - Si es true, es un formulario de actualización (oculta email)
  @param {object} customer - Objeto del cliente (solo para actualización)
{% enddoc %}

<form id="custom-invoice-form" class="custom-invoice-form">
  {% if is_update and customer %}
    <input type="hidden" id="customer_id" name="customer_id" value="{{ customer.id }}" />
  {% endif %}

  <!-- Sección 1: Datos Personales -->
  <div class="form-section">
    <h3 class="form-section-title">Datos personales</h3>
    
    <div class="custom-invoice-form-row">
      <div class="custom-invoice-form-group">
        <label for="first_name" class="custom-invoice-label">
          Nombre
        </label>
        <input 
          type="text" 
          id="first_name" 
          name="first_name" 
          class="custom-invoice-input" 
          placeholder="Ariel"
          required
          pattern="[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+"
          minlength="1"
        />
        <span class="custom-invoice-error" id="first_name_error"></span>
      </div>

      <div class="custom-invoice-form-group">
        <label for="last_name" class="custom-invoice-label">
          Apellido
        </label>
        <input 
          type="text" 
          id="last_name" 
          name="last_name" 
          class="custom-invoice-input" 
          placeholder="García"
          required
          pattern="[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+"
          minlength="1"
        />
        <span class="custom-invoice-error" id="last_name_error"></span>
      </div>
    </div>

    <div class="custom-invoice-form-group">
      <label for="email" class="custom-invoice-label">
        Correo electrónico
      </label>
      <input 
        type="email" 
        id="email" 
        name="email" 
        class="custom-invoice-input" 
        placeholder="ariel.garcia@ejemplo.com"
        required
        {% if is_update and customer %}readonly value="{{ customer.email }}"{% endif %}
      />
      <span class="custom-invoice-error" id="email_error"></span>
    </div>

    <div class="custom-invoice-form-row">
      <div class="custom-invoice-form-group">
        <label for="birth_date" class="custom-invoice-label">
          Fecha de nacimiento
        </label>
        <div class="birth-date-fields">
          <select id="birth_day" name="birth_day" class="custom-invoice-input" required>
            <option value="">Día</option>
            {% for i in (1..31) %}
              <option value="{{ i }}">{{ i }}</option>
            {% endfor %}
          </select>
          <select id="birth_month" name="birth_month" class="custom-invoice-input" required>
            <option value="">Mes</option>
            <option value="01">Ene</option>
            <option value="02">Feb</option>
            <option value="03">Mar</option>
            <option value="04">Abr</option>
            <option value="05">May</option>
            <option value="06">Jun</option>
            <option value="07">Jul</option>
            <option value="08">Ago</option>
            <option value="09">Sep</option>
            <option value="10">Oct</option>
            <option value="11">Nov</option>
            <option value="12">Dic</option>
          </select>
          <select id="birth_year" name="birth_year" class="custom-invoice-input" required>
            <option value="">Año</option>
            {% assign current_year = 'now' | date: '%Y' | plus: 0 %}
            {% assign min_year = current_year | minus: 120 %}
            {% for year in (min_year..current_year) reversed %}
              <option value="{{ year }}">{{ year }}</option>
            {% endfor %}
          </select>
        </div>
        <input type="hidden" id="birth_date" name="birth_date" />
        <span class="custom-invoice-error" id="birth_date_error"></span>
      </div>

      <div class="custom-invoice-form-group">
        <label for="gender" class="custom-invoice-label">
          Género        </label>
        <select id="gender" name="gender" class="custom-invoice-input" required>
          <option value="">Seleccione</option>
          <option value="M">Masculino</option>
          <option value="F">Femenino</option>
          <option value="X">Otro</option>
          <option value="X">Prefiero no decir</option>
        </select>
        <span class="custom-invoice-error" id="gender_error"></span>
      </div>
    </div>

    <div class="custom-invoice-form-group">
      <label for="phone" class="custom-invoice-label">
        Celular
      </label>
      <input 
        type="text" 
        id="phone" 
        name="phone" 
        class="custom-invoice-input" 
        placeholder="61234567"
        required
        inputmode="numeric"
      />
      <span class="custom-invoice-error" id="phone_error"></span>
    </div>

    <div class="custom-invoice-form-group">
      <label for="country" class="custom-invoice-label">
        País
      </label>
      <select id="country" name="country" class="custom-invoice-input" required>
        <option value="">Seleccione un país</option>
        <!-- Los países se cargarán dinámicamente desde JavaScript -->
      </select>
      <span class="custom-invoice-error" id="country_error"></span>
    </div>
  </div>

  <!-- Sección 2: Información de Facturación (condicional) -->
  <div class="form-section" id="billing-section" style="display: none;">
    <h3 class="form-section-title">Información de facturación</h3>

    <!-- Campos para Extranjero (país ≠ Panamá) -->
    <div id="foreign-billing-fields" style="display: none;">
      <div class="custom-invoice-form-group">
        <label for="tax_id_foreign" class="custom-invoice-label">
          Pasaporte o Identificación
        </label>
        <input 
          type="text" 
          id="tax_id_foreign" 
          name="tax_id_foreign" 
          class="custom-invoice-input" 
        />
        <span class="custom-invoice-error" id="tax_id_foreign_error"></span>
      </div>

      <div class="custom-invoice-form-group">
        <label for="customer_type_foreign" class="custom-invoice-label">
          Tipo de cliente
        </label>
        <select id="customer_type_foreign" name="customer_type_foreign" class="custom-invoice-input">
          <option value="04">Extranjero</option>
        </select>
        <span class="custom-invoice-error" id="customer_type_foreign_error"></span>
      </div>
    </div>

    <!-- Campos para Panamá -->
    <div id="panama-billing-fields" style="display: none;">
      <div class="custom-invoice-form-group">
        <label for="customer_type" class="custom-invoice-label">
          Tipo de cliente
        </label>
        <select id="customer_type" name="customer_type" class="custom-invoice-input">
          <option value="">Seleccione</option>
          <option value="01">Contribuyente</option>
          <option value="02">Consumidor final</option>
        </select>
        <span class="custom-invoice-error" id="customer_type_error"></span>
      </div>

      <!-- Campos para Contribuyente -->
      <div id="contribuyente-fields" style="display: none;">
        <div class="custom-invoice-form-group">
          <label for="tax_id_contribuyente" class="custom-invoice-label">
            Cédula o RUC
          </label>
          <input 
            type="text" 
            id="tax_id_contribuyente" 
            name="tax_id_contribuyente" 
            class="custom-invoice-input" 
          />
          <span class="custom-invoice-error" id="tax_id_contribuyente_error"></span>
        </div>

        <div class="custom-invoice-form-group">
          <label for="customer_dv" class="custom-invoice-label">
            DV          </label>
          <input 
            type="text" 
            id="customer_dv" 
            name="customer_dv" 
            class="custom-invoice-input" 
          />
          <span class="custom-invoice-error" id="customer_dv_error"></span>
        </div>

        <div class="custom-invoice-form-group">
          <label for="taxpayer_name_contribuyente" class="custom-invoice-label">
            Razón social
          </label>
          <input 
            type="text" 
            id="taxpayer_name_contribuyente" 
            name="taxpayer_name_contribuyente" 
            class="custom-invoice-input" 
          />
          <span class="custom-invoice-error" id="taxpayer_name_contribuyente_error"></span>
        </div>

        <div class="custom-invoice-form-group">
          <label for="taxpayer_kind_contribuyente" class="custom-invoice-label">
            Tipo de contribuyente
          </label>
          <select id="taxpayer_kind_contribuyente" name="taxpayer_kind_contribuyente" class="custom-invoice-input">
            <option value="">Seleccione</option>
            <option value="1">Natural</option>
            <option value="2">Jurídico</option>
          </select>
          <span class="custom-invoice-error" id="taxpayer_kind_contribuyente_error"></span>
        </div>
      </div>

      <!-- Campos para Consumidor final -->
      <div id="consumidor-fields" style="display: none;">
        <div class="custom-invoice-form-group">
          <label for="tax_id_consumidor" class="custom-invoice-label">
            Cédula
          </label>
          <input 
            type="text" 
            id="tax_id_consumidor" 
            name="tax_id_consumidor" 
            class="custom-invoice-input" 
          />
          <span class="custom-invoice-error" id="tax_id_consumidor_error"></span>
        </div>

        <div class="custom-invoice-form-group">
          <label for="taxpayer_name_consumidor" class="custom-invoice-label">
            Razón social
          </label>
          <input 
            type="text" 
            id="taxpayer_name_consumidor" 
            name="taxpayer_name_consumidor" 
            class="custom-invoice-input" 
          />
          <span class="custom-invoice-error" id="taxpayer_name_consumidor_error"></span>
        </div>

        <div class="custom-invoice-form-group">
          <label for="taxpayer_kind_consumidor" class="custom-invoice-label">
            Tipo de contribuyente
          </label>
          <select id="taxpayer_kind_consumidor" name="taxpayer_kind_consumidor" class="custom-invoice-input">
            <option value="">Seleccione</option>
            <option value="1">Natural</option>
            <option value="2">Jurídico</option>
          </select>
          <span class="custom-invoice-error" id="taxpayer_kind_consumidor_error"></span>
        </div>
      </div>

      <!-- Campos de ubicación (solo para Panamá) -->
      <div class="custom-invoice-form-row">
        <div class="custom-invoice-form-group">
          <label for="province" class="custom-invoice-label">
            Provincia
          </label>
          <select id="province" name="province" class="custom-invoice-input">
            <option value="">Seleccione</option>
            <option value="test">Test</option>
          </select>
          <span class="custom-invoice-error" id="province_error"></span>
        </div>

        <div class="custom-invoice-form-group">
          <label for="district" class="custom-invoice-label">
            Distrito
          </label>
          <select id="district" name="district" class="custom-invoice-input">
            <option value="">Seleccione</option>
            <option value="test">Test</option>
          </select>
          <span class="custom-invoice-error" id="district_error"></span>
        </div>
      </div>

      <div class="custom-invoice-form-group">
        <label for="corregimiento" class="custom-invoice-label">
          Corregimiento
        </label>
        <select id="corregimiento" name="corregimiento" class="custom-invoice-input">
          <option value="">Seleccione</option>
          <option value="test">Test</option>
        </select>
        <span class="custom-invoice-error" id="corregimiento_error"></span>
      </div>
    </div>
  </div>
</form>
